###############################################################################
#  Tauroi Technologies — Quant Pipeline (Production)
#
#  This workflow IS the live trading signal engine. It runs on a schedule,
#  fetches real-time data from Chartmetric + Kalshi, computes the model
#  fair value, and persists the signal to signals/signal_log.jsonl.
#
#  IMPORTANT: The application lives in the tauroi-prediction-engine/
#  subdirectory.  All pip / python / path references use that as the
#  working-directory.
#
#  Triggers:
#    - Cron: every hour (live market monitoring — respects Chartmetric rate limits)
#    - Push to main/dev (CI: tests + signal generation)
#    - Manual dispatch (on-demand signal check)
#
#  Secrets required (set in GitHub → Settings → Secrets → Actions):
#    - KALSHI_ACCESS_KEY
#    - KALSHI_API_SECRET
#    - CHARTMETRIC_REFRESH_TOKEN
#    - CHARTMETRIC_ARTIST_ID       (optional, defaults to 214945)
#    - ARTIST_NAME                 (optional, defaults to "Bad Bunny")
###############################################################################

name: Quant Pipeline

on:
  push:
    branches: ["main", "dev"]
  schedule:
    - cron: "0 * * * *"           # every hour (top of the hour)
  workflow_dispatch:              # allow manual runs from the Actions tab

# Prevent concurrent runs from overlapping
concurrency:
  group: quant-pipeline
  cancel-in-progress: true

# ── All jobs share this working directory ────────────────────────────────────
defaults:
  run:
    working-directory: tauroi-prediction-engine

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  #  JOB 1: Unit Tests (fast gate — blocks signal generation if broken)
  # ═══════════════════════════════════════════════════════════════════════════
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: tauroi-prediction-engine/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run unit tests
        run: python -m pytest tests/ -v --tb=short

  # ═══════════════════════════════════════════════════════════════════════════
  #  JOB 2: Live Signal Generation (runs after tests pass)
  # ═══════════════════════════════════════════════════════════════════════════
  signal:
    needs: test
    runs-on: ubuntu-latest

    # Only run the live engine if secrets are configured
    # (forks / PRs won't have them)
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: tauroi-prediction-engine/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ── Restore Chartmetric data cache from previous runs ──────────
      # This avoids re-fetching full history on every run (prevents
      # rate limiting). The cache key rolls with run_id so every run
      # can write back; restore-keys lets it pick up the most recent.
      - name: Restore Chartmetric data cache
        uses: actions/cache@v4
        with:
          path: tauroi-prediction-engine/cache/
          key: chartmetric-cache-${{ hashFiles('tauroi-prediction-engine/requirements.txt') }}-${{ github.run_id }}
          restore-keys: |
            chartmetric-cache-${{ hashFiles('tauroi-prediction-engine/requirements.txt') }}-

      - name: Run live signal engine (full market scan)
        env:
          KALSHI_ACCESS_KEY: ${{ secrets.KALSHI_ACCESS_KEY }}
          KALSHI_API_SECRET: ${{ secrets.KALSHI_API_SECRET }}
          CHARTMETRIC_REFRESH_TOKEN: ${{ secrets.CHARTMETRIC_REFRESH_TOKEN }}
          CHARTMETRIC_ARTIST_ID: ${{ secrets.CHARTMETRIC_ARTIST_ID || '214945' }}
          ARTIST_NAME: ${{ secrets.ARTIST_NAME || 'Bad Bunny' }}
        run: python main.py --scan --dry-run

      - name: Upload signal log as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signal-log-${{ github.run_id }}
          path: tauroi-prediction-engine/signals/signal_log.jsonl
          retention-days: 90

      - name: Commit signal log to repo
        if: success()
        # This step must run at the repo root for git commands
        working-directory: .
        run: |
          git config user.name "Tauroi Bot"
          git config user.email "bot@tauroi.dev"
          git add tauroi-prediction-engine/signals/signal_log.jsonl
          # Only commit if there are changes
          git diff --cached --quiet || \
            git commit -m "signal: $(date -u '+%Y-%m-%d %H:%M UTC')" && \
            git push
