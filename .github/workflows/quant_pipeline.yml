###############################################################################
#  Tauroi Technologies — Quant Pipeline (Production)
#
#  Pure belief-model pipeline: uses ONLY Kalshi price data.
#  No Chartmetric dependency — the logit jump-diffusion model operates
#  entirely on tick-level trade history from Kalshi.
#
#  The signal loop runs continuously (every 60s) inside a single job,
#  restarting every ~5.5 hours to stay under GitHub's 6-hour limit.
#  On restart, the executor reconciles local state against the Kalshi
#  API, so no positions or orders are lost.
#
#  Modes:
#    - Push to main → DRY-RUN (CI verification, no real orders)
#    - Cron / manual dispatch → LIVE MARKET-MAKING (real orders on Kalshi)
#
#  Risk controls (hardcoded in risk_manager.py):
#    - Max 10% daily loss circuit breaker
#    - Max 25 contracts per order
#    - Max 50 contracts per ticker
#    - $10 minimum balance floor
#    - All orders placed with post_only=True (maker fees only)
#    - 8c default half-spread (net profitable after 1.5c/fill fee)
#
#  Triggers:
#    - Cron: every 6 hours (restarts the long-running loop)
#    - Push to main (CI: tests + one dry-run signal cycle)
#    - Manual dispatch (on-demand, live trading)
#
#  Secrets required (set in GitHub → Settings → Secrets → Actions):
#    - KALSHI_ACCESS_KEY
#    - KALSHI_API_SECRET
###############################################################################

name: Quant Pipeline

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "0 */5 * * *"          # every 5 hours (overlaps kill previous via concurrency)
  workflow_dispatch:                # manual runs from the Actions tab

# Prevent concurrent runs from overlapping
concurrency:
  group: quant-pipeline
  cancel-in-progress: true

# ── All jobs share this working directory ────────────────────────────────────
defaults:
  run:
    working-directory: tauroi-prediction-engine

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  #  JOB 1: Unit Tests (fast gate — blocks signal generation if broken)
  # ═══════════════════════════════════════════════════════════════════════════
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: tauroi-prediction-engine/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run unit tests
        run: python -m pytest tests/ -v --tb=short

  # ═══════════════════════════════════════════════════════════════════════════
  #  JOB 2: Live Market-Making Loop (belief-only, Kalshi data only)
  # ═══════════════════════════════════════════════════════════════════════════
  signal:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write           # required for git push (signal log commit)

    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: tauroi-prediction-engine/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ── Restore HF data cache from previous runs ─────────────────
      - name: Restore Kalshi HF data cache
        uses: actions/cache@v4
        with:
          path: tauroi-prediction-engine/cache/
          key: kalshi-hf-cache-${{ hashFiles('tauroi-prediction-engine/requirements.txt') }}-${{ github.run_id }}
          restore-keys: |
            kalshi-hf-cache-${{ hashFiles('tauroi-prediction-engine/requirements.txt') }}-

      # ── Restore position/order state from previous runs ──────────
      - name: Restore executor state
        uses: actions/cache@v4
        with:
          path: tauroi-prediction-engine/state/
          key: executor-state-${{ github.run_id }}
          restore-keys: |
            executor-state-

      # ── Run the belief-only signal loop ──────────────────────────
      # Push events → DRY-RUN (CI verification, no real orders)
      # Schedule/dispatch → LIVE MARKET-MAKING (real orders)
      - name: Run belief signal engine
        timeout-minutes: 340
        env:
          KALSHI_ACCESS_KEY: ${{ secrets.KALSHI_ACCESS_KEY }}
          KALSHI_API_SECRET: ${{ secrets.KALSHI_API_SECRET }}
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "CI mode: single dry-run belief cycle"
            python main.py --belief --scan --dry-run
          else
            echo "LIVE MARKET-MAKING: belief scan every 60s (max 330 min)"
            echo "Half-spread: 8c | Max order: 25 | Max daily loss: 10%"
            timeout 19800 python main.py \
              --belief --scan --live --market-making \
              --mm-spread 8 \
              --max-order-size 10 \
              --max-daily-loss 0.10 \
              --loop --interval 60 \
              || true
          fi

      - name: Upload signal log as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signal-log-${{ github.run_id }}
          path: tauroi-prediction-engine/signals/signal_log.jsonl
          retention-days: 90

      - name: Upload executor state as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: executor-state-${{ github.run_id }}
          path: tauroi-prediction-engine/state/
          retention-days: 90

      - name: Commit signal log to repo
        if: success()
        working-directory: .
        run: |
          git config user.name "Tauroi Bot"
          git config user.email "bot@tauroi.dev"
          git add tauroi-prediction-engine/signals/signal_log.jsonl
          git diff --cached --quiet || \
            git commit -m "signal: $(date -u '+%Y-%m-%d %H:%M UTC')" && \
            git push
